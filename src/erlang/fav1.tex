% -*- mode: noweb; ess-noweb-default-code-mode: erlang-mode; -*-% ===> this file was generated automatically by noweave --- better not edit it
% \documentclass[twoside]{article}
\documentclass{tufte-handout}
\usepackage{noweb}

\usepackage{hyperref}
% l2h macro href 2 <a href="#$1">#2</a>
\hypersetup{
  bookmarks=true,
  pdffitwindow=true,
  pdfstartview={FitH},
  pdftitle={My favorite Erlang Program},
  pdfauthor={Joe Armstrong},
  pdfsubject={Erlang and other stuff},
  pdfcreator={Eric Bailey <eric@ericb.me>},
  pdfkeywords={Erlang, universal server, literate programming, noweb},
  colorlinks=true,
  linkcolor=red,
  citecolor=green,
  filecolor=magenta,
  urlcolor=cyan
}

% \usepackage[parfill]{parskip}

\usepackage{amsmath}
\usepackage{amssymb}

\usepackage[outputdir=src/erlang]{minted}

% \pagestyle{noweb}
% NOTE: Use shift option for wide code.
\noweboptions{smallcode,shortxref,webnumbering,english}

\title{My favorite Erlang Program\thanks{This {\tt noweb} version of the
    original blog post\cite{Armstrong2013} was translated, edited and annotated
    by \href{https://github.com/yurrriq}{Eric Bailey}.}}

% \author{Joe Armstrong\\{\small Translated to {\tt noweb} by Eric Bailey}}
\author{Joe Armstrong}

\date{November 21, 2013}

\newcommand{\stylehook}{\marginpar{\raggedright\sl Style hook}}

\newmintinline[erl]{erlang}{}

\begin{document}
\maketitle
\nwfilename{src/erlang/fav1.nw}\nwbegindocs{1}\nwdocspar

\begin{abstract}
  The other day I got a mail from Dean Galvin from Rowan University. Dean was
  doing an Erlang project so he asked ``What example program would best
  exemplify Erlang''.

  He wanted a small program, that would be suitable for a ten minute talk that
  would best show off the language. I thought for a while ... and quickly wrote
  my favorite program, it's the ``Universal server''.
\end{abstract}

% \tableofcontents
% \newpage

\section{The Universal Server}\label{sec:universal_server}
Normally servers do something. An HTTP server responds to HTTP requests, an FTP
server response to FTP requests and so on. But what about a {\sl Universal
  Server}? Surely we can generalize the idea of a server and make a universal
server, which we can later tell to become a specific server.

Here's my universal server:
\nwenddocs{}\nwbegincode{2}\sublabel{NW3Gelxe-2PSniS-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3Gelxe-2PSniS-1}}}\moddef{The Universal Server~{\nwtagstyle{}\subpageref{NW3Gelxe-2PSniS-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW3Gelxe-3wQJEV-1}}\nwenddeflinemarkup
\nwindexdefn{\nwixident{universal{\_}server}}{universal:unserver}{NW3Gelxe-2PSniS-1}\nwlinkedidentc{universal_server}{NW3Gelxe-2PSniS-1}() ->
    \LA{}Wait for a ``become F'' message and become an F server~{\nwtagstyle{}\subpageref{NW3Gelxe-1bGa3u-1}}\RA{}
    end.
\nwused{\\{NW3Gelxe-3wQJEV-1}}\nwidentdefs{\\{{\nwixident{universal{\_}server}}{universal:unserver}}}\nwendcode{}\nwbegindocs{3}\nwdocspar

\sidenote{
  A universal server waits for a \erl{{become, F}} message
  and then becomes an \erl{F} server.
}
\nwenddocs{}\nwbegincode{4}\sublabel{NW3Gelxe-1bGa3u-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3Gelxe-1bGa3u-1}}}\moddef{Wait for a ``become F'' message and become an F server~{\nwtagstyle{}\subpageref{NW3Gelxe-1bGa3u-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW3Gelxe-2PSniS-1}}\nwenddeflinemarkup
receive
    \{become, F\} ->
        F()
\nwused{\\{NW3Gelxe-2PSniS-1}}\nwendcode{}\nwbegindocs{5}\nwdocspar

That was pretty easy. Once I have created a universal server, it just sits and
waits for a \erl{{become, F}} message and then it becomes an \erl{F} server.
\newpage

\section{The Factorial Server}\label{sec:factorial_server}
A factorial server is a server which waits for an integer and sends back the
factorial of an integer. This is mind-bogglingly simple:
\nwenddocs{}\nwbegincode{6}\sublabel{NW3Gelxe-1ehRvX-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3Gelxe-1ehRvX-1}}}\moddef{The Factorial Server~{\nwtagstyle{}\subpageref{NW3Gelxe-1ehRvX-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW3Gelxe-3wQJEV-1}}\nwenddeflinemarkup
\nwindexdefn{\nwixident{factorial{\_}server}}{factorial:unserver}{NW3Gelxe-1ehRvX-1}\nwlinkedidentc{factorial_server}{NW3Gelxe-1ehRvX-1}() ->
    \LA{}Wait for an integer N and send back factorial(N)~{\nwtagstyle{}\subpageref{NW3Gelxe-1FtCec-1}}\RA{},
            \nwlinkedidentc{factorial_server}{NW3Gelxe-1ehRvX-1}()
    end.

\LA{}The factorial function~{\nwtagstyle{}\subpageref{NW3Gelxe-3ZjObT-1}}\RA{}
\nwused{\\{NW3Gelxe-3wQJEV-1}}\nwidentdefs{\\{{\nwixident{factorial{\_}server}}{factorial:unserver}}}\nwendcode{}\nwbegindocs{7}\nwdocspar

\sidenote{
  A factorial server simply waits for an integer $n$ and sends back $n!$.
}
\nwenddocs{}\nwbegincode{8}\sublabel{NW3Gelxe-1FtCec-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3Gelxe-1FtCec-1}}}\moddef{Wait for an integer N and send back factorial(N)~{\nwtagstyle{}\subpageref{NW3Gelxe-1FtCec-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW3Gelxe-1ehRvX-1}}\nwenddeflinemarkup
receive
    \{From, N\} ->
        From ! \nwlinkedidentc{factorial}{NW3Gelxe-3ZjObT-1}(N)
\nwused{\\{NW3Gelxe-1ehRvX-1}}\nwidentuses{\\{{\nwixident{factorial}}{factorial}}}\nwindexuse{\nwixident{factorial}}{factorial}{NW3Gelxe-1FtCec-1}\nwendcode{}\nwbegindocs{9}\nwdocspar

\sidenote{
  The Erlang definition of \erl{factorial/1} bears a striking resemblance
  to the recurrence relation:
  \begin{align*}
    n! = \begin{cases}
      1 & \text{if } n = 0, \\
      (n-1)!\times n & \text{if } n > 0.
    \end{cases}
  \end{align*}
}
\nwenddocs{}\nwbegincode{10}\sublabel{NW3Gelxe-3ZjObT-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3Gelxe-3ZjObT-1}}}\moddef{The factorial function~{\nwtagstyle{}\subpageref{NW3Gelxe-3ZjObT-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW3Gelxe-1ehRvX-1}}\nwenddeflinemarkup
\nwindexdefn{\nwixident{factorial}}{factorial}{NW3Gelxe-3ZjObT-1}\nwlinkedidentc{factorial}{NW3Gelxe-3ZjObT-1}(0) -> 1;
\nwlinkedidentc{factorial}{NW3Gelxe-3ZjObT-1}(N) -> N * \nwlinkedidentc{factorial}{NW3Gelxe-3ZjObT-1}(N-1).
\nwused{\\{NW3Gelxe-1ehRvX-1}}\nwidentdefs{\\{{\nwixident{factorial}}{factorial}}}\nwendcode{}\nwbegindocs{11}\nwdocspar

Now we're ready to rock and roll...

\section{Putting It All Together}\label{sec:test}
I'll write a little function that creates a
\hyperref[sec:universal_server]{universal server} and sends it a ``become a
\hyperref[sec:factorial_server]{factorial server}'' message. Then I'll send it
an integer, wait for the response, and print the response:
\nwenddocs{}\nwbegincode{12}\sublabel{NW3Gelxe-4Sd2Fj-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3Gelxe-4Sd2Fj-1}}}\moddef{Putting It All Together~{\nwtagstyle{}\subpageref{NW3Gelxe-4Sd2Fj-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW3Gelxe-3wQJEV-1}}\nwenddeflinemarkup
\nwindexdefn{\nwixident{test}}{test}{NW3Gelxe-4Sd2Fj-1}\nwlinkedidentc{test}{NW3Gelxe-4Sd2Fj-1}() ->
    \LA{}Create a universal server~{\nwtagstyle{}\subpageref{NW3Gelxe-1bdq1V-1}}\RA{},
    \LA{}Send it a ``become a factorial server'' message~{\nwtagstyle{}\subpageref{NW3Gelxe-21ZjIj-1}}\RA{},
    \LA{}Send it an integer~{\nwtagstyle{}\subpageref{NW3Gelxe-1C7uCK-1}}\RA{}
    \LA{}Wait for the response and print the response~{\nwtagstyle{}\subpageref{NW3Gelxe-3b0uok-1}}\RA{}
    end.
\nwused{\\{NW3Gelxe-3wQJEV-1}}\nwidentdefs{\\{{\nwixident{test}}{test}}}\nwendcode{}\nwbegindocs{13}\nwdocspar
\newpage

\sidenote{
  \erl{test/0} creates a \hyperref[sec:universal_server]{universal server},
  binding its pid to \erl{Pid};
}
\nwenddocs{}\nwbegincode{14}\sublabel{NW3Gelxe-1bdq1V-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3Gelxe-1bdq1V-1}}}\moddef{Create a universal server~{\nwtagstyle{}\subpageref{NW3Gelxe-1bdq1V-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW3Gelxe-4Sd2Fj-1}}\nwenddeflinemarkup
Pid = spawn(fun \nwlinkedidentc{universal_server}{NW3Gelxe-2PSniS-1}/0)
\nwused{\\{NW3Gelxe-4Sd2Fj-1}}\nwidentuses{\\{{\nwixident{universal{\_}server}}{universal:unserver}}}\nwindexuse{\nwixident{universal{\_}server}}{universal:unserver}{NW3Gelxe-1bdq1V-1}\nwendcode{}\nwbegindocs{15}\nwdocspar

\sidenote{
  ... sends \erl{Pid} a ``become a
  \hyperref[sec:factorial_server]{factorial server}'' message;
}
\nwenddocs{}\nwbegincode{16}\sublabel{NW3Gelxe-21ZjIj-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3Gelxe-21ZjIj-1}}}\moddef{Send it a ``become a factorial server'' message~{\nwtagstyle{}\subpageref{NW3Gelxe-21ZjIj-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW3Gelxe-4Sd2Fj-1}}\nwenddeflinemarkup
Pid ! \{become, fun \nwlinkedidentc{factorial_server}{NW3Gelxe-1ehRvX-1}/0\}
\nwused{\\{NW3Gelxe-4Sd2Fj-1}}\nwidentuses{\\{{\nwixident{factorial{\_}server}}{factorial:unserver}}}\nwindexuse{\nwixident{factorial{\_}server}}{factorial:unserver}{NW3Gelxe-21ZjIj-1}\nwendcode{}\nwbegindocs{17}\nwdocspar

\sidenote{
  ... sends \erl{Pid} $50$, thereby asking the newly-specialized
  \hyperref[sec:factorial_server]{factorial server} to compute and respond with
  the value of $50!$;
}
\nwenddocs{}\nwbegincode{18}\sublabel{NW3Gelxe-1C7uCK-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3Gelxe-1C7uCK-1}}}\moddef{Send it an integer~{\nwtagstyle{}\subpageref{NW3Gelxe-1C7uCK-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW3Gelxe-4Sd2Fj-1}}\nwenddeflinemarkup
Pid ! \{self(), 50\},
\nwused{\\{NW3Gelxe-4Sd2Fj-1}}\nwendcode{}\nwbegindocs{19}\nwdocspar

\sidenote{... waits for the response and prints the response.}
\nwenddocs{}\nwbegincode{20}\sublabel{NW3Gelxe-3b0uok-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3Gelxe-3b0uok-1}}}\moddef{Wait for the response and print the response~{\nwtagstyle{}\subpageref{NW3Gelxe-3b0uok-1}}}\endmoddef\nwstartdeflinemarkup\nwusesondefline{\\{NW3Gelxe-4Sd2Fj-1}}\nwenddeflinemarkup
receive
    X ->
        io:format("~w~n", [X])
\nwused{\\{NW3Gelxe-4Sd2Fj-1}}\nwendcode{}\nwbegindocs{21}\nwdocspar

%% TODO: Add a link to fav1.erl
All these functions belong to the module \erl{fav1}, which exports
\hyperref[sec:test]{\erl{test/0}}:
\nwenddocs{}\nwbegincode{22}\sublabel{NW3Gelxe-3wQJEV-1}\nwmargintag{{\nwtagstyle{}\subpageref{NW3Gelxe-3wQJEV-1}}}\moddef{fav1~{\nwtagstyle{}\subpageref{NW3Gelxe-3wQJEV-1}}}\endmoddef\nwstartdeflinemarkup\nwenddeflinemarkup
-module(fav1).
-export([\nwlinkedidentc{test}{NW3Gelxe-4Sd2Fj-1}/0]).

\LA{}Putting It All Together~{\nwtagstyle{}\subpageref{NW3Gelxe-4Sd2Fj-1}}\RA{}

\LA{}The Universal Server~{\nwtagstyle{}\subpageref{NW3Gelxe-2PSniS-1}}\RA{}

\LA{}The Factorial Server~{\nwtagstyle{}\subpageref{NW3Gelxe-1ehRvX-1}}\RA{}
\nwnotused{fav1}\nwidentuses{\\{{\nwixident{test}}{test}}}\nwindexuse{\nwixident{test}}{test}{NW3Gelxe-3wQJEV-1}\nwendcode{}

\nwixlogsorted{c}{{Create a universal server}{NW3Gelxe-1bdq1V-1}{\nwixu{NW3Gelxe-4Sd2Fj-1}\nwixd{NW3Gelxe-1bdq1V-1}}}%
\nwixlogsorted{c}{{fav1}{NW3Gelxe-3wQJEV-1}{\nwixd{NW3Gelxe-3wQJEV-1}}}%
\nwixlogsorted{c}{{Putting It All Together}{NW3Gelxe-4Sd2Fj-1}{\nwixd{NW3Gelxe-4Sd2Fj-1}\nwixu{NW3Gelxe-3wQJEV-1}}}%
\nwixlogsorted{c}{{Send it a ``become a factorial server'' message}{NW3Gelxe-21ZjIj-1}{\nwixu{NW3Gelxe-4Sd2Fj-1}\nwixd{NW3Gelxe-21ZjIj-1}}}%
\nwixlogsorted{c}{{Send it an integer}{NW3Gelxe-1C7uCK-1}{\nwixu{NW3Gelxe-4Sd2Fj-1}\nwixd{NW3Gelxe-1C7uCK-1}}}%
\nwixlogsorted{c}{{The factorial function}{NW3Gelxe-3ZjObT-1}{\nwixu{NW3Gelxe-1ehRvX-1}\nwixd{NW3Gelxe-3ZjObT-1}}}%
\nwixlogsorted{c}{{The Factorial Server}{NW3Gelxe-1ehRvX-1}{\nwixd{NW3Gelxe-1ehRvX-1}\nwixu{NW3Gelxe-3wQJEV-1}}}%
\nwixlogsorted{c}{{The Universal Server}{NW3Gelxe-2PSniS-1}{\nwixd{NW3Gelxe-2PSniS-1}\nwixu{NW3Gelxe-3wQJEV-1}}}%
\nwixlogsorted{c}{{Wait for a ``become F'' message and become an F server}{NW3Gelxe-1bGa3u-1}{\nwixu{NW3Gelxe-2PSniS-1}\nwixd{NW3Gelxe-1bGa3u-1}}}%
\nwixlogsorted{c}{{Wait for an integer N and send back factorial(N)}{NW3Gelxe-1FtCec-1}{\nwixu{NW3Gelxe-1ehRvX-1}\nwixd{NW3Gelxe-1FtCec-1}}}%
\nwixlogsorted{c}{{Wait for the response and print the response}{NW3Gelxe-3b0uok-1}{\nwixu{NW3Gelxe-4Sd2Fj-1}\nwixd{NW3Gelxe-3b0uok-1}}}%
\nwixlogsorted{i}{{\nwixident{factorial}}{factorial}}%
\nwixlogsorted{i}{{\nwixident{factorial{\_}server}}{factorial:unserver}}%
\nwixlogsorted{i}{{\nwixident{test}}{test}}%
\nwixlogsorted{i}{{\nwixident{universal{\_}server}}{universal:unserver}}%
\nwbegindocs{23}$\square$
\newpage

\section{Chunks}
\nowebchunks

\section{Index}
\nowebindex

\bibliography{fav1}
\bibliographystyle{plainnat}

\end{document}
\nwenddocs{}
